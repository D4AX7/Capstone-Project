using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Moq;
using System.Security.Claims;
using UtilityManagmentApi.Controllers;
using UtilityManagmentApi.DTOs.BillingCycle;
using UtilityManagmentApi.DTOs.Common;
using UtilityManagmentApi.Services.Interfaces;
using Xunit;

namespace UtilityManagementTest.Unit_Test.Controllers;

/// <summary>
/// Unit tests for BillingCyclesController
/// </summary>
public class BillingCyclesControllerTests
{
    private readonly Mock<IBillingCycleService> _mockBillingCycleService;
    private readonly BillingCyclesController _controller;

    public BillingCyclesControllerTests()
    {
        _mockBillingCycleService = new Mock<IBillingCycleService>();
        _controller = new BillingCyclesController(_mockBillingCycleService.Object);
    }

    private void SetupUserClaims(int userId, string role)
    {
        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.NameIdentifier, userId.ToString()),
          new Claim(ClaimTypes.Role, role)
        };
        var identity = new ClaimsIdentity(claims, "TestAuth");
        _controller.ControllerContext = new ControllerContext
        {
            HttpContext = new DefaultHttpContext { User = new ClaimsPrincipal(identity) }
        };
    }

    [Fact]
    public async Task GetAll_ReturnsOkResult()
    {
        // Arrange
        var cycles = new List<BillingCycleDto> { new BillingCycleDto { Id = 1, Name = "Jan 2025" } };
        _mockBillingCycleService.Setup(s => s.GetAllAsync(null))
        .ReturnsAsync(ApiResponse<List<BillingCycleDto>>.SuccessResponse(cycles));

        // Act
        var result = await _controller.GetAll(null);

        // Assert
        Assert.IsType<OkObjectResult>(result);
    }

    [Fact]
    public async Task GetAll_WithYearFilter_ReturnsOkResult()
    {
        // Arrange
        var cycles = new List<BillingCycleDto> { new BillingCycleDto { Id = 1, Name = "Jan 2025", Year = 2025 } };
        _mockBillingCycleService.Setup(s => s.GetAllAsync(2025))
.ReturnsAsync(ApiResponse<List<BillingCycleDto>>.SuccessResponse(cycles));

        // Act
        var result = await _controller.GetAll(2025);

        // Assert
Assert.IsType<OkObjectResult>(result);
    }

    [Fact]
    public async Task GetCurrentCycle_ReturnsOkResult()
  {
      // Arrange
        var cycle = new BillingCycleDto { Id = 1, Name = "Jan 2025", Status = "Open" };
        _mockBillingCycleService.Setup(s => s.GetCurrentCycleAsync())
       .ReturnsAsync(ApiResponse<BillingCycleDto>.SuccessResponse(cycle));

        // Act
  var result = await _controller.GetCurrentCycle();

        // Assert
     Assert.IsType<OkObjectResult>(result);
    }

[Fact]
    public async Task GetCurrentCycle_NotFound_ReturnsNotFound()
 {
        // Arrange
        _mockBillingCycleService.Setup(s => s.GetCurrentCycleAsync())
         .ReturnsAsync(ApiResponse<BillingCycleDto>.ErrorResponse("No current cycle"));

        // Act
        var result = await _controller.GetCurrentCycle();

        // Assert
Assert.IsType<NotFoundObjectResult>(result);
    }

    [Fact]
    public async Task Create_WithValidData_ReturnsOkResult()
  {
 // Arrange
        SetupUserClaims(1, "Admin");
        var createDto = new CreateBillingCycleDto { Month = 2, Year = 2025 };
        var cycleDto = new BillingCycleDto { Id = 1, Name = "February 2025", Month = 2, Year = 2025 };
      _mockBillingCycleService.Setup(s => s.CreateAsync(createDto, 1))
            .ReturnsAsync(ApiResponse<BillingCycleDto>.SuccessResponse(cycleDto));

      // Act
   var result = await _controller.Create(createDto);

// Assert
    Assert.IsType<OkObjectResult>(result);
    }

    [Fact]
    public async Task Create_DuplicateCycle_ReturnsBadRequest()
    {
        // Arrange
   SetupUserClaims(1, "Admin");
        var createDto = new CreateBillingCycleDto { Month = 1, Year = 2025 };
      _mockBillingCycleService.Setup(s => s.CreateAsync(createDto, 1))
            .ReturnsAsync(ApiResponse<BillingCycleDto>.ErrorResponse("Billing cycle already exists for this period"));

        // Act
        var result = await _controller.Create(createDto);

        // Assert
        Assert.IsType<BadRequestObjectResult>(result);
    }

    [Fact]
    public async Task Update_WithValidData_ReturnsOkResult()
    {
     // Arrange
     var updateDto = new UpdateBillingCycleDto { Status = "Closed" };
        var cycleDto = new BillingCycleDto { Id = 1, Name = "Jan 2025", Status = "Closed" };
        _mockBillingCycleService.Setup(s => s.UpdateAsync(1, updateDto))
    .ReturnsAsync(ApiResponse<BillingCycleDto>.SuccessResponse(cycleDto));

      // Act
  var result = await _controller.Update(1, updateDto);

        // Assert
        Assert.IsType<OkObjectResult>(result);
    }

    [Fact]
    public async Task Update_NotFound_ReturnsBadRequest()
    {
        // Arrange
 var updateDto = new UpdateBillingCycleDto { Status = "Closed" };
        _mockBillingCycleService.Setup(s => s.UpdateAsync(999, updateDto))
 .ReturnsAsync(ApiResponse<BillingCycleDto>.ErrorResponse("Billing cycle not found"));

        // Act
 var result = await _controller.Update(999, updateDto);

        // Assert
        Assert.IsType<BadRequestObjectResult>(result);
}

    [Fact]
    public async Task Delete_WithValidId_ReturnsOkResult()
    {
     // Arrange
_mockBillingCycleService.Setup(s => s.DeleteAsync(1))
    .ReturnsAsync(ApiResponse<bool>.SuccessResponse(true));

        // Act
        var result = await _controller.Delete(1);

        // Assert
        Assert.IsType<OkObjectResult>(result);
    }

    [Fact]
  public async Task Delete_NotFound_ReturnsBadRequest()
  {
      // Arrange
        _mockBillingCycleService.Setup(s => s.DeleteAsync(999))
            .ReturnsAsync(ApiResponse<bool>.ErrorResponse("Billing cycle not found"));

    // Act
    var result = await _controller.Delete(999);

  // Assert
      Assert.IsType<BadRequestObjectResult>(result);
    }

    [Fact]
    public async Task Delete_CycleWithBills_ReturnsBadRequest()
    {
        // Arrange
  _mockBillingCycleService.Setup(s => s.DeleteAsync(1))
     .ReturnsAsync(ApiResponse<bool>.ErrorResponse("Cannot delete billing cycle with existing bills"));

        // Act
 var result = await _controller.Delete(1);

        // Assert
        Assert.IsType<BadRequestObjectResult>(result);
    }
}
