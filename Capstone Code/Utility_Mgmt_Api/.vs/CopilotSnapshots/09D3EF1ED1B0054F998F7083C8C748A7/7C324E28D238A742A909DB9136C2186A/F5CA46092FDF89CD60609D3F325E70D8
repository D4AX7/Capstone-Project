using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Moq;
using System.Security.Claims;
using UtilityManagmentApi.Controllers;
using UtilityManagmentApi.DTOs.BillingCycle;
using UtilityManagmentApi.DTOs.Common;
using UtilityManagmentApi.Services.Interfaces;
using Xunit;

namespace UtilityManagementTest.Unit_Test.Controllers;

/// <summary>
/// Unit tests for BillingCyclesController - Tests billing cycle management
/// </summary>
public class BillingCyclesControllerTests
{
    private readonly Mock<IBillingCycleService> _mockBillingCycleService;
    private readonly BillingCyclesController _controller;

    public BillingCyclesControllerTests()
    {
        _mockBillingCycleService = new Mock<IBillingCycleService>();
        _controller = new BillingCyclesController(_mockBillingCycleService.Object);
    }

    private void SetupUserClaims(int userId, string role)
    {
        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.NameIdentifier, userId.ToString()),
            new Claim(ClaimTypes.Role, role)
        };
        var identity = new ClaimsIdentity(claims, "TestAuth");
        var claimsPrincipal = new ClaimsPrincipal(identity);

        _controller.ControllerContext = new ControllerContext
        {
            HttpContext = new DefaultHttpContext { User = claimsPrincipal }
        };
    }

    #region GetAll Tests

    [Fact]
    public async Task GetAll_ReturnsOkResult_WithBillingCyclesList()
    {
        // Arrange
        var billingCycles = new List<BillingCycleDto>
        {
            new BillingCycleDto { Id = 1, Name = "January 2025", Month = 1, Year = 2025 },
            new BillingCycleDto { Id = 2, Name = "February 2025", Month = 2, Year = 2025 }
        };

        _mockBillingCycleService.Setup(s => s.GetAllAsync(null))
            .ReturnsAsync(ApiResponse<List<BillingCycleDto>>.SuccessResponse(billingCycles));

        // Act
        var result = await _controller.GetAll(null);

        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var response = Assert.IsType<ApiResponse<List<BillingCycleDto>>>(okResult.Value);
        Assert.Equal(2, response.Data?.Count);
    }

    #endregion

    #region GetCurrentCycle Tests

    [Fact]
    public async Task GetCurrentCycle_WhenExists_ReturnsOkResult()
    {
        // Arrange
        var currentCycle = new BillingCycleDto { Id = 1, Name = "January 2026", Status = "Open" };

        _mockBillingCycleService.Setup(s => s.GetCurrentCycleAsync())
         .ReturnsAsync(ApiResponse<BillingCycleDto>.SuccessResponse(currentCycle));

      // Act
        var result = await _controller.GetCurrentCycle();

        // Assert
        Assert.IsType<OkObjectResult>(result);
    }

    [Fact]
    public async Task GetCurrentCycle_WhenNotExists_ReturnsNotFound()
    {
        // Arrange
        _mockBillingCycleService.Setup(s => s.GetCurrentCycleAsync())
            .ReturnsAsync(ApiResponse<BillingCycleDto>.ErrorResponse("No current billing cycle found"));

        // Act
        var result = await _controller.GetCurrentCycle();

        // Assert
   Assert.IsType<NotFoundObjectResult>(result);
    }

    #endregion

    #region Create Tests

    [Fact]
    public async Task Create_WithValidData_ReturnsOkResult()
    {
        // Arrange
        SetupUserClaims(1, "Admin");
        var createDto = new CreateBillingCycleDto { Month = 3, Year = 2025 };
        var cycleDto = new BillingCycleDto { Id = 3, Name = "March 2025", Month = 3, Year = 2025 };

      _mockBillingCycleService.Setup(s => s.CreateAsync(createDto, 1))
            .ReturnsAsync(ApiResponse<BillingCycleDto>.SuccessResponse(cycleDto));

        // Act
 var result = await _controller.Create(createDto);

        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
    var response = Assert.IsType<ApiResponse<BillingCycleDto>>(okResult.Value);
      Assert.True(response.Success);
    }

    [Fact]
    public async Task Create_WithDuplicateCycle_ReturnsBadRequest()
    {
        // Arrange
        SetupUserClaims(1, "Admin");
      var createDto = new CreateBillingCycleDto { Month = 1, Year = 2025 };

        _mockBillingCycleService.Setup(s => s.CreateAsync(createDto, 1))
            .ReturnsAsync(ApiResponse<BillingCycleDto>.ErrorResponse("Billing cycle already exists"));

    // Act
      var result = await _controller.Create(createDto);

        // Assert
   Assert.IsType<BadRequestObjectResult>(result);
    }

    #endregion

    #region Delete Tests

    [Fact]
    public async Task Delete_WithValidId_ReturnsOkResult()
    {
        // Arrange
      _mockBillingCycleService.Setup(s => s.DeleteAsync(1))
.ReturnsAsync(ApiResponse<bool>.SuccessResponse(true));

        // Act
        var result = await _controller.Delete(1);

        // Assert
        Assert.IsType<OkObjectResult>(result);
    }

    [Fact]
    public async Task Delete_WithInvalidId_ReturnsBadRequest()
    {
 // Arrange
        _mockBillingCycleService.Setup(s => s.DeleteAsync(999))
     .ReturnsAsync(ApiResponse<bool>.ErrorResponse("Billing cycle not found"));

  // Act
     var result = await _controller.Delete(999);

        // Assert
        Assert.IsType<BadRequestObjectResult>(result);
    }

    #endregion
}
