using Microsoft.AspNetCore.Mvc;
using Moq;
using UtilityManagmentApi.Controllers;
using UtilityManagmentApi.DTOs.Auth;
using UtilityManagmentApi.DTOs.Common;
using UtilityManagmentApi.Services.Interfaces;
using Xunit;

namespace UtilityManagementTest.Unit_Test.Controllers;

/// <summary>
/// Unit tests for AuthController - Tests authentication and authorization endpoints
/// </summary>
public class AuthControllerTests
{
    private readonly Mock<IAuthService> _mockAuthService;
    private readonly AuthController _controller;

    public AuthControllerTests()
    {
        _mockAuthService = new Mock<IAuthService>();
        _controller = new AuthController(_mockAuthService.Object);
}

    #region Login Tests

    [Fact]
    public async Task Login_WithValidCredentials_ReturnsOkResult()
    {
        // Arrange
        var loginRequest = new LoginRequestDto
  {
            Email = "admin@utilitybilling.com",
 Password = "Admin@123"
        };

        var userDto = new UserDto
        {
Id = 1,
     Email = loginRequest.Email,
            FirstName = "Admin",
            LastName = "User",
            Role = "Admin",
            IsActive = true
      };

        var loginResponse = new LoginResponseDto
        {
            Token = "valid-jwt-token",
      RefreshToken = "refresh-token",
         Expiration = DateTime.UtcNow.AddHours(24),
     User = userDto
   };

        _mockAuthService.Setup(s => s.LoginAsync(loginRequest))
            .ReturnsAsync(ApiResponse<LoginResponseDto>.SuccessResponse(loginResponse));

        // Act
        var result = await _controller.Login(loginRequest);

        // Assert
  var okResult = Assert.IsType<OkObjectResult>(result);
        var response = Assert.IsType<ApiResponse<LoginResponseDto>>(okResult.Value);
      Assert.True(response.Success);
        Assert.NotNull(response.Data?.Token);
    }

    [Fact]
  public async Task Login_WithInvalidCredentials_ReturnsUnauthorized()
    {
        // Arrange
     var loginRequest = new LoginRequestDto
        {
            Email = "invalid@email.com",
   Password = "wrongpassword"
   };

        _mockAuthService.Setup(s => s.LoginAsync(loginRequest))
   .ReturnsAsync(ApiResponse<LoginResponseDto>.ErrorResponse("Invalid email or password"));

        // Act
     var result = await _controller.Login(loginRequest);

// Assert
     var unauthorizedResult = Assert.IsType<UnauthorizedObjectResult>(result);
        var response = Assert.IsType<ApiResponse<LoginResponseDto>>(unauthorizedResult.Value);
        Assert.False(response.Success);
    }

    #endregion

    #region Consumer Registration Tests

    [Fact]
    public async Task RegisterConsumer_WithValidData_ReturnsOkResult()
    {
        // Arrange
        var registerRequest = new ConsumerRegisterDto
        {
            Email = "newconsumer@email.com",
         Password = "Consumer@123",
            FirstName = "John",
     LastName = "Doe",
 Phone = "1234567890",
            Address = "123 Main St",
          City = "Springfield",
       State = "Illinois",
            PostalCode = "62701"
   };

        var userDto = new UserDto
      {
       Id = 5,
     Email = registerRequest.Email,
            FirstName = registerRequest.FirstName,
         LastName = registerRequest.LastName,
            Role = "Consumer",
    IsActive = true,
 ConsumerNumber = "CON240006"
        };

        var loginResponse = new LoginResponseDto
        {
      Token = "new-jwt-token",
            RefreshToken = "new-refresh-token",
       Expiration = DateTime.UtcNow.AddHours(24),
            User = userDto
      };

        _mockAuthService.Setup(s => s.RegisterConsumerAsync(registerRequest))
            .ReturnsAsync(ApiResponse<LoginResponseDto>.SuccessResponse(loginResponse));

        // Act
        var result = await _controller.RegisterConsumer(registerRequest);

        // Assert
 var okResult = Assert.IsType<OkObjectResult>(result);
    var response = Assert.IsType<ApiResponse<LoginResponseDto>>(okResult.Value);
      Assert.True(response.Success);
 }

    [Fact]
    public async Task RegisterConsumer_WithExistingEmail_ReturnsBadRequest()
    {
        // Arrange
      var registerRequest = new ConsumerRegisterDto
        {
            Email = "existing@email.com",
  Password = "Consumer@123",
         FirstName = "John",
   LastName = "Doe",
 Phone = "1234567890",
        Address = "123 Main St",
          City = "Springfield",
            State = "Illinois",
   PostalCode = "62701"
};

        _mockAuthService.Setup(s => s.RegisterConsumerAsync(registerRequest))
  .ReturnsAsync(ApiResponse<LoginResponseDto>.ErrorResponse("Email already exists"));

        // Act
        var result = await _controller.RegisterConsumer(registerRequest);

        // Assert
        Assert.IsType<BadRequestObjectResult>(result);
    }

    #endregion

    #region Staff Registration Tests

    [Fact]
    public async Task RegisterStaff_WithValidData_ReturnsOkResult()
    {
        // Arrange
        var registerRequest = new RegisterRequestDto
  {
     Email = "newbilling@utilitybilling.com",
            Password = "Billing@123",
          FirstName = "Jane",
      LastName = "Smith",
    Phone = "9876543210",
            Role = "BillingOfficer"
      };

        var userDto = new UserDto
  {
        Id = 10,
          Email = registerRequest.Email,
   FirstName = registerRequest.FirstName,
            LastName = registerRequest.LastName,
     Role = registerRequest.Role,
            IsActive = true
        };

        _mockAuthService.Setup(s => s.RegisterAsync(registerRequest))
.ReturnsAsync(ApiResponse<UserDto>.SuccessResponse(userDto));

        // Act
      var result = await _controller.RegisterStaff(registerRequest);

      // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
      var response = Assert.IsType<ApiResponse<UserDto>>(okResult.Value);
        Assert.True(response.Success);
        Assert.Equal("BillingOfficer", response.Data?.Role);
    }

    #endregion

    #region User Management Tests

    [Fact]
    public async Task GetAllUsers_ReturnsOkResult_WithUsersList()
    {
        // Arrange
        var users = new List<UserDto>
        {
            new UserDto { Id = 1, Email = "admin@test.com", Role = "Admin" },
    new UserDto { Id = 2, Email = "billing@test.com", Role = "BillingOfficer" },
            new UserDto { Id = 3, Email = "consumer@test.com", Role = "Consumer" }
   };

        _mockAuthService.Setup(s => s.GetAllUsersAsync())
            .ReturnsAsync(ApiResponse<List<UserDto>>.SuccessResponse(users));

   // Act
    var result = await _controller.GetAllUsers();

        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var response = Assert.IsType<ApiResponse<List<UserDto>>>(okResult.Value);
    Assert.True(response.Success);
        Assert.Equal(3, response.Data?.Count);
    }

    [Fact]
  public async Task DeleteUser_WithValidId_ReturnsOkResult()
    {
        // Arrange
        var userId = 5;

        _mockAuthService.Setup(s => s.DeleteUserAsync(userId))
            .ReturnsAsync(ApiResponse<bool>.SuccessResponse(true));

        // Act
    var result = await _controller.DeleteUser(userId);

        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var response = Assert.IsType<ApiResponse<bool>>(okResult.Value);
      Assert.True(response.Success);
    }

  #endregion
}
